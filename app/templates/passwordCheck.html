<html>
<script src="{{ url_for('static', filename='js/bcrypt.js') }}"></script>
<script type="text/javascript" src="https://cdn.rawgit.com/ricmoo/aes-js/e27b99df/index.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/emn178/js-sha256/build/sha256.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
<body>
<input id="password" name="password" required type="password" placeholder="password">
<input id="room" name="room" required type="text" placeholder="room">
<button onclick="compareHash()">validate</button>
<form method="POST">
    {{ form.hidden_tag() }}
    <input id="response" name="response" type="hidden" value="">
    <input id="submit" name="submit" type="submit" value="Send">
</form>
</body>
<script>
    const salt = "{{ form.salt }}"; // gets values from server
    const challenge = "{{ form.challenge }}";
</script>
<script>
    const bcrypt = dcodeIO.bcrypt;

    function compareHash() {
        let hash = bcrypt.hashSync(document.getElementById("password").value, salt) // read password from input field, calculate hash
        key = sha256.hex(hash).toString().substring(0, 64); // calculate hash of password hash
        response = aes256Decrypt(key, challenge) // decrypt challenge using key above

        session_key = sha256.hex(bcrypt.genSaltSync()).toString().substring(0, 64) // create new key (session_key) 
        room = document.getElementById("room").value // read room value
        Cookies.set("session_key", session_key)
        Cookies.set("room", room) // set cookies
        document.getElementById("response").value = aes256Encrypt(response, JSON.stringify({
            "session_key": session_key,
            "room": room 
        })) // send encrypted datas to server
    }
</script>
<script>
    function aes256Encrypt(key, text) {
        var key_256 = parseHexString(key);
        var textBytes = aesjs.utils.utf8.toBytes(text);
        var aesCtr = new aesjs.ModeOfOperation.ctr(key_256, new aesjs.Counter(5));
        var encryptedBytes = aesCtr.encrypt(textBytes);
        var encryptedHex = aesjs.utils.hex.fromBytes(encryptedBytes);
        return encryptedHex;
    }

    function aes256Decrypt(key, ciphertext) {
        var key_256 = parseHexString(key);
        var encryptedBytes = aesjs.utils.hex.toBytes(ciphertext);
        var aesCtr = new aesjs.ModeOfOperation.ctr(key_256, new aesjs.Counter(5));
        var decryptedBytes = aesCtr.decrypt(encryptedBytes);
        var decryptedText = aesjs.utils.utf8.fromBytes(decryptedBytes);
        return decryptedText;
    }

    function parseHexString(str) {
        var result = [];
        while (str.length >= 2) {
            result.push(parseInt(str.substring(0, 2), 16));
            str = str.substring(2, str.length);
        }
        return result;
    }
</script>
</html>
